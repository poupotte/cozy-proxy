// Generated by CoffeeScript 1.10.0
var RealtimeAdapter, remoteAccess;

RealtimeAdapter = require('cozy-realtime-adapter');

remoteAccess = require('lib/remote_access');

module.exports = function(app, callback) {
  var eventsToForward, realtime;
  eventsToForward = ['device.*'];
  realtime = RealtimeAdapter(app.server, eventsToForward);
  return realtime.on('device.*', function(event, id) {
    return remoteAccess.updateCredentials(function(err) {
      if (err != null) {
        console.log(err);
      }
      return Application.find(id, function(err, app) {
        var message, messageKey, options;
        if (err) {
          return console.log(err.stack);
        } else if ((app != null ? app.state : void 0) === 'broken') {
          messageKey = 'installation message failure';
          options = {
            appName: app.displayName
          };
          message = localizationManager.t(messageKey, options);
          return notifhelper.createTemporary({
            text: message,
            resource: {
              app: 'home'
            }
          });
        }
      });
    });
  });
};
